<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <record id="account_move_form_view_inherited_guia" model="ir.ui.view">
    <field name="name">account.move.view.form.inherit.guia</field>
    <field name="model">account.move</field>
    <!-- Ajusta el XMLID base si difiere en tu instalación -->
    <field name="inherit_id" ref="l10n_pe_edi_odoofact.view_move_form"/>
    <field name="arch" type="xml">

      <!-- Reemplazamos el grupo para controlar dominio y opciones -->
      <xpath expr="//group[@name='reference_guides_group']" position="replace">
        <group string="Reference Guides" name="reference_guides_group"
               invisible="move_type not in ('out_invoice','out_refund','in_invoice','in_refund')">

          <!--
            Reglas del dominio:
            - Misma compañía
            - gre_doc_name no nulo ni vacío
            - Si existe gre_account_move_id:
                * permitir pickings no usados (False)
                * permitir los usados por ESTA factura (id)
          -->
          <field name="stock_picking_ids"
                 nolabel="1"
                 colspan="2"
                 readonly="state != 'draft'"
                 widget="many2many_tags"
                 domain="[
                    ('company_id','=',company_id),
                    ('gre_doc_name','!=',False),
                    ('gre_doc_name','not in',['',' ']),
                    '|',
                        ('gre_account_move_id','=',False),
                        ('gre_account_move_id','=', id)
                 ]"
                 options="{'no_create': True, 'no_create_edit': True, 'no_open': True}"/>
        </group>
      </xpath>

    </field>
  </record>

</odoo>
